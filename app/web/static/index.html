<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kassa Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background-color: var(--tg-theme-bg-color, #f3f4f6);
        color: var(--tg-theme-text-color, #1f2937);
      }
      .card {
        background-color: var(--tg-theme-secondary-bg-color, #ffffff);
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
      }
    </style>
  </head>
  <body class="antialiased p-4">
    <div id="app" class="max-w-3xl mx-auto space-y-6 pb-20">
      <div v-if="loading" class="flex justify-center items-center h-64">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"
        ></div>
      </div>

      <div v-else-if="error" class="card text-center text-red-500">
        <p class="font-bold text-lg">Xatolik yuz berdi</p>
        <p class="text-sm mt-2">{{ error }}</p>
        <button
          @click="fetchData"
          class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg font-medium"
        >
          Qayta urinish
        </button>
      </div>

      <template v-else>
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-bold">ğŸ“Š Kassa Dashboard</h1>
          <button
            @click="fetchData"
            class="text-blue-500 flex items-center gap-1 font-medium bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg active:scale-95 transition-transform"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
            Yangilash
          </button>
        </div>

        <!-- Balances -->
        <div class="card space-y-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            ğŸ’° Jami Balans
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div
              v-for="(amount, currency) in data.balances"
              :key="currency"
              class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700"
            >
              <div class="text-sm font-medium text-gray-500 mb-1">
                {{ currency }}
              </div>
              <div
                class="font-bold text-2xl"
                :class="amount < 0 ? 'text-red-500' : 'text-gray-900 dark:text-white'"
              >
                {{ formatNumber(amount) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Daily Profit -->
        <div class="card space-y-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            ğŸ“ˆ Bugungi Sof Foyda (Kirim-Chiqim)
          </h2>
          <div
            v-if="Object.keys(data.daily_profits).length === 0"
            class="text-gray-500 py-2"
          >
            ğŸ“ˆ Bugun operatsiyalar yo'q.
          </div>
          <div v-else class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div
              v-for="(amount, currency) in data.daily_profits"
              :key="'prof_'+currency"
              class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800"
            >
              <div
                class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-1"
              >
                {{ currency }}
              </div>
              <div
                class="font-bold text-2xl"
                :class="amount < 0 ? 'text-red-500' : 'text-blue-700 dark:text-blue-300'"
              >
                {{ amount > 0 ? '+' : '' }}{{ formatNumber(amount) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="card">
          <h2 class="text-xl font-semibold mb-4">
            ğŸ’³ Tranzaksiyalar (So'nggi 20)
          </h2>
          <div class="relative h-48 w-full">
            <canvas id="txChart"></canvas>
          </div>
        </div>

        <!-- Debtors -->
        <div class="card space-y-4" v-if="data.debts && data.debts.length > 0">
          <h2 class="text-xl font-semibold">ğŸ™â€â™‚ï¸ Mijoz Qarzlari (Top 10)</h2>
          <div class="space-y-2">
            <div
              v-for="debt in data.debts"
              :key="debt.client+debt.currency"
              class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg"
            >
              <span class="font-medium text-gray-800 dark:text-gray-200"
                >{{ debt.client }}</span
              >
              <span
                class="font-bold text-red-500 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded"
                >{{ formatNumber(debt.amount) }} {{ debt.currency }}</span
              >
            </div>
          </div>
        </div>

        <!-- Deep dive: Recent transactions -->
        <div class="card space-y-4">
          <h2 class="text-xl font-semibold">ğŸ“ Lenta</h2>
          <div class="space-y-3">
            <div
              v-for="tx in data.recent_entries"
              :key="tx.id"
              class="flex flex-col p-4 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700"
            >
              <div
                class="flex justify-between font-bold mb-1 border-b border-gray-200 dark:border-gray-700 pb-2"
              >
                <span class="text-gray-800 dark:text-gray-200"
                  >#{{ tx.id }} &bull; {{ tx.client_name }}</span
                >
                <span
                  :class="tx.flow_direction === 'INFLOW' ? 'text-green-600' : 'text-red-500'"
                >
                  {{ tx.flow_direction === 'INFLOW' ? 'ğŸ“¥ +' : 'ğŸ“¤ -' }}{{
                  formatNumber(tx.amount) }}
                  <span class="text-sm font-normal"
                    >{{ tx.currency_code }}</span
                  >
                </span>
              </div>
              <div class="text-sm flex justify-between pt-1">
                <span class="text-gray-400"
                  >{{ new Date(tx.created_at).toLocaleString([], {month:'short',
                  day:'numeric', hour:'2-digit', minute:'2-digit'}) }}</span
                >
                <span class="text-gray-600 dark:text-gray-300 font-medium"
                  >{{ tx.note || '-' }}</span
                >
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <script>
      const { createApp, ref, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          const tg = window.Telegram.WebApp;
          const loading = ref(true);
          const error = ref(null);
          const data = ref({
            balances: {},
            daily_profits: {},
            debts: [],
            recent_entries: [],
          });
          let chartInstance = null;

          tg.expand();
          tg.ready();
          tg.setHeaderColor("secondary_bg_color");

          // Show MainButton to close dashboard
          tg.MainButton.setText("Yopish")
            .show()
            .onClick(() => tg.close());

          const formatNumber = (num) => {
            return Number(num).toLocaleString("ru-RU", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 2,
            });
          };

          const renderChart = () => {
            if (chartInstance) chartInstance.destroy();

            const ctx = document.getElementById("txChart");
            if (!ctx || !data.value.recent_entries.length) return;

            const recent = [...data.value.recent_entries].reverse();
            const labels = recent.map((tx) =>
              new Date(tx.created_at).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              }),
            );
            const amounts = recent.map((tx) =>
              tx.flow_direction === "INFLOW"
                ? Number(tx.amount)
                : -Number(tx.amount),
            );

            // Use CSS variables for dynamic theme
            const isDark = tg.colorScheme === "dark";
            const gridColor = isDark
              ? "rgba(255,255,255,0.1)"
              : "rgba(0,0,0,0.05)";
            const textColor = isDark ? "#9ca3af" : "#6b7280";

            Chart.defaults.color = textColor;
            Chart.defaults.font.family = "Inter, system-ui, sans-serif";

            chartInstance = new Chart(ctx, {
              type: "bar",
              data: {
                labels,
                datasets: [
                  {
                    label: "Oqim",
                    data: amounts,
                    backgroundColor: amounts.map((a) =>
                      a >= 0
                        ? "rgba(34, 197, 94, 0.8)"
                        : "rgba(239, 68, 68, 0.8)",
                    ),
                    borderRadius: 6,
                    borderSkipped: false,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => {
                        const tx = recent[ctx.dataIndex];
                        const sign = tx.flow_direction === "INFLOW" ? "+" : "-";
                        return `${sign}${formatNumber(tx.amount)} ${tx.currency_code} (${tx.client_name})`;
                      },
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: gridColor },
                    ticks: {
                      callback: (value) =>
                        value > 1000 ? value / 1000 + "k" : value,
                    },
                  },
                  x: { grid: { display: false } },
                },
              },
            });
          };

          const fetchData = async () => {
            loading.value = true;
            error.value = null;
            try {
              const initData = tg.initData || "";

              const response = await fetch("/api/reports", {
                headers: {
                  "X-TG-Init-Data": initData,
                },
              });

              if (!response.ok) {
                if (response.status === 401)
                  throw new Error(
                    "Avtorizatsiya xatosi (Faqat Telegram orqali kiring)",
                  );
                throw new Error(`Server xatosi: ${response.status}`);
              }

              data.value = await response.json();
              nextTick(() => renderChart());
            } catch (err) {
              error.value = err.message;
            } finally {
              loading.value = false;
            }
          };

          onMounted(() => {
            fetchData();
          });

          return {
            loading,
            error,
            data,
            fetchData,
            formatNumber,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
